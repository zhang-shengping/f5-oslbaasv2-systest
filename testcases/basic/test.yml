
- set_fact:
    test_casename: "basic test"
    test_listener_protocol: HTTP
    test_pool_protocol: HTTP
    test_listener_tcpport: 80
    test_healthmonitor_protocol: HTTP

- import_tasks: ../../playbooks/task-define-resources.yml

- import_tasks: ../../playbooks/task-create-resources.yml

- import_tasks: ../../playbooks/task-check-resources.yml

# - name: get created resource id
#   shell: |
#     source {{ openrc }} && {{ item }} --format value --column id
#   with_items:
#     - neutron lbaas-loadbalancer-show {{ loadbalancer }}
#     - neutron lbaas-listener-show {{ listener }}
#     - neutron lbaas-pool-show {{ pool }}
#     - neutron lbaas-member-list {{ pool }}
#     - neutron lbaas-healthmonitor-show {{ healthmonitor }}
#   register: resource_ids

# - debug: msg="{{ resource_id }}"

# - name: collect bigip partitions
#   bigip_device_info:
#     gather_subset:
#       - partitions
#       - self-ips
#       - vlans
#     provider:
#       user: admin
#       server: "{{ inventory_hostname }}"
#       password: "{{ admin_password }}"
#       validate_certs: False
#   register: bigip_infos


- name: "Check {{ test_listener_protocol }} {{ test_listener_tcpport }} is reachable"
  shell: curl http://{{ vip_address.stdout }}:{{ test_listener_tcpport }} warn=false
  delegate_to: "{{ item }}"
  with_items: "{{groups['clients']}}"
  when: test_env == 'lab'

- import_tasks: ../../playbooks/task-remove-resources.yml